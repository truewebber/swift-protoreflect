# Руководство разработчика SwiftProtoReflect

## Важно прочитать сначала!

**ВНИМАНИЕ:** После каждого коммита ты теряешь всю память о проделанной работе. Этот документ поможет тебе быстро восстановить контекст и продолжить разработку.

## Рабочий процесс с учетом потери памяти

1. **Первым делом после возвращения к проекту:**
   - Прочитай файл PROJECT_STATE.md для понимания текущего статуса
   - Проверь секцию "Активные задачи" и "Последние обновления"
   - Запусти `git log -5` чтобы узнать, что было сделано в последних коммитах

2. **Перед началом работы:**
   - Определи задачу из PROJECT_STATE.md
   - Изучи структуру соответствующего модуля и его _README.md
   - Запусти тесты чтобы увидеть, что работает

3. **Во время работы:**
   - Комментируй код так, чтобы твоё "будущее я" могло понять логику
   - Делай небольшие атомарные изменения
   - Обновляй _README.md модуля, над которым работаешь
   - **Стремись к максимальному покрытию кода тестами** - это критически важно для качества библиотеки
     - Целевой показатель: 90%+ (близко к 100%)
     - Исключения допустимы для путей с `fatalError` или других непроверяемых условий

4. **Перед каждым коммитом (обязательно!):**
   - Обнови PROJECT_STATE.md, отметив завершенные задачи
   - Запусти `make test && make coverage` и убедись, что все тесты проходят и покрытие кода достаточное
   - Сделай подробное сообщение коммита с префиксом модуля: `[Module] What was done - Why it was done this way - What's next`
   - Запусти `./Scripts/update-state.sh` после коммита для обновления секции "Последние обновления"

## Структура проекта

- **Sources/SwiftProtoReflect/** - основной код библиотеки:
  - **Descriptor/** - система дескрипторов протобаф сообщений
  - **Dynamic/** - динамическое представление и манипуляция сообщениями
  - **Serialization/** - сериализация/десериализация
  - **Registry/** - централизованное управление типами
  - **Service/** - взаимодействие с gRPC
  - **Bridge/** - интеграция с Swift Protobuf
  - **Errors/** - обработка ошибок

- **Tests/SwiftProtoReflectTests/** - тесты, структура соответствует модулям

## Фазы разработки

См. раздел "Предстоящие фазы разработки" в PROJECT_STATE.md

## Кодовые соглашения

- Следуй стилю Swift-кода из соседних файлов
- Используй документацию в формате DocC с /// для публичного API
- Добавляй тесты для каждой новой функциональности
- **Требуется высокое покрытие кода тестами** - используй `make coverage` для проверки
  - Недостижимые пути (например, с `fatalError`) могут быть исключены из требования 100% покрытия
  - Важно: добавь комментарий, объясняющий, почему конкретный путь не покрыт тестами

## Тестирование и обработка ошибок

### Тестирование критических сбоев

Некоторые функции используют `fatalError()` для обработки недопустимых состояний, которые не должны возникать при нормальной работе. Эти пути сложно или невозможно протестировать стандартными средствами.

Примеры не тестируемых путей в коде:
- Проверка наличия обязательных параметров в конструкторах
- Валидация типов, которые должны иметь соответствующие имена типов
- Проверка структурной целостности составных объектов

Для таких путей:
1. Добавь четкий комментарий, объясняющий почему случается `fatalError`
2. Используй тесты для проверки корректных случаев использования
3. Используй специальные ожидания (XCTExpectFailure) там, где применимо

## Полезные команды

```bash
# Проверка состояния
git log -5                      # Последние 5 коммитов
git diff HEAD~1                 # Что изменилось в последнем коммите

# Разработка
make lint                       # Проверка кода
make format                     # Форматирование кода
swift test                      # Запуск тестов
make coverage                   # Проверка покрытия кода тестами

# Создание новых компонентов
./Scripts/setup-module.sh Descriptor FileDescriptor  # Создает заготовки файлов для нового компонента

# Обновление состояния
./Scripts/update-state.sh       # Обновление PROJECT_STATE.md
```

## Создание новых компонентов

Для быстрого создания заготовок файлов для новых компонентов используй скрипт:

```bash
./Scripts/setup-module.sh <Имя модуля> <Имя компонента>
```

Скрипт автоматически:
- Создаст .swift файл компонента с шаблоном кода в соответствующем модуле
- Создаст файл с тестами для компонента
- Обновит _README.md модуля, добавив новый компонент в список
- Напомнит обновить PROJECT_STATE.md и сделать коммит

Пример:
```bash
./Scripts/setup-module.sh Descriptor FileDescriptor
```
